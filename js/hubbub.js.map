{"version":3,"sources":["hubbub.js"],"names":["Hubbub","getComments","el","callback","gistId","getAttribute","gistUrlAttr","match","cache","has","get","url","useFixtures","apiRoot","ajax","dataType","comments","parseMarkdown","err","innerHTML","opts","reqDataType","type","delimiter","String","fromCharCode","reqText","reduce","mem","curr","body","data","text","blob","parsedComments","split","forEach","comment","i","html_body","trim","set","renderComments","heading","document","createElement","setAttribute","link","textContent","length","appendChild","renderComment","container","cssClass","renderAvatar","user","content","renderHeader","renderCommentBody","header","un","username","html_url","login","commentUrl","id","pl","permalink","renderTimestamp","created_at","timestamp","diff","Date","now","getTime","Math","round","str","hours","days","commentBody","options","success","error","req","XMLHttpRequest","addEventListener","res","readyState","status","JSON","parse","target","responseText","open","setRequestHeader","send","stringify","a","avatarLink","img","avatar","avatar_url","window","containerClass","widgets","querySelectorAll","hubbub","key","life","localStorage","getItem","createdAt","removeItem","setItem","call","appendWidget","gistUrl","div","css"],"mappings":"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","file":"hubbub.js","sourcesContent":["/*!\n    Hubbub\n\n    by Chris Newton <http://chrisnewtn.com>,\n       Seanewt <http://seanewt.com>,\n       Dharmafly <http://dharmafly.com>\n\n    Repo: <https://github.com/asyncjs/hubbub>\n    MIT license\n*/\n\nvar Hubbub = (function() {\n\n  \"use strict\";\n\n  if ( ![].forEach || !window.XMLHttpRequest ) {\n    return;\n  }\n\n  var containerClass = \"hubbub\",\n      gistUrlAttr    = \"data-gist-url\",\n      apiRoot        = \"https://api.github.com/\",\n      widgets        = document.querySelectorAll( \".\" + containerClass ),\n      hubbub         = {},\n      useFixtures    = false;\n\n  var cssClass = {\n    avatar: \"hubbub-avatar\",\n    avatarLink: \"hubbub-avatar-link\",\n    header: \"hubbub-header\",\n    username: \"hubbub-username\",\n    commentBody: \"hubbub-comment-body\",\n    timestamp: \"hubbub-timestamp\",\n    permalink: \"hubbub-permalink\",\n    content: \"hubbub-content\",\n    container: \"hubbub-container\"\n  };\n\n  var cache = (function() {\n    var key  = \"hubbub-\",\n        life = 60 * 60 * 1000;\n\n    return {\n      has: function( id ) {\n        return localStorage.getItem( key + id ) !== null;\n      },\n      get: function( id ) {\n        var blob = JSON.parse( localStorage.getItem( key + id ) );\n        if ( blob !== null ) {\n          if ( (Date.now() - blob.createdAt) > life ) {\n            localStorage.removeItem( key + id );\n          }\n        }\n        return blob.comments;\n      },\n      set: function( id, comments ) {\n        var blob = { comments: comments, createdAt: Date.now() };\n        localStorage.setItem( key + id, JSON.stringify( blob ) );\n      }\n    };\n  })();\n\n  // Initial setup\n  [].forEach.call( widgets, function( el ) {\n    getComments( el, renderComments );\n  });\n\n  function getComments ( el, callback ) {\n    var gistId = el.getAttribute( gistUrlAttr ).match( /\\/(\\w+)\\/?$/ )[ 1 ];\n\n    if ( cache.has( gistId ) ) {\n      callback( el, cache.get( gistId ), gistId );\n    } else {\n      var url;\n      if ( useFixtures ) {\n        url = \"fixtures/\" + gistId + \".json\";\n      } else {\n        url = apiRoot + \"gists/\" + gistId + \"/comments\";\n      }\n      ajax({\n        url:url,\n        dataType: \"json\"\n      }, function( comments ) {\n        parseMarkdown( comments, gistId, el, callback );\n      }, function( err ) {\n        el.innerHTML = el.innerHTML + \"<small>Error fetching Comments</small>\";\n      });\n    }\n  }\n\n  function parseMarkdown ( comments, gistId, el, callback ) {\n    var opts = {\n      url: apiRoot + \"markdown\",\n      reqDataType: \"json\",\n      type: \"POST\"\n    };\n    var delimiter = String.fromCharCode( 0x3091 );\n\n    var reqText = comments.reduce(function( mem, curr ) {\n      return mem + curr.body + \"\\r\\n\\r\\n\" + delimiter + \"\\r\\n\\r\\n\";\n    }, \"\" );\n\n    opts.data = { text: reqText };\n\n    ajax( opts, function( blob ) {\n      var parsedComments = blob.split( \"<p>\" + delimiter + \"</p>\" );\n      parsedComments.forEach(function( comment, i ) {\n        if ( comments[ i ] ) {\n          comments[ i ].html_body = comment.trim();\n        }\n      });\n      cache.set( gistId, comments );\n      callback( el, comments );\n    });\n  }\n\n  function renderComments ( el, comments ) {\n    var heading = document.createElement( \"h3\" );\n    heading.setAttribute(\"class\", \"heading\" );\n    var link = document.createElement(\"a\" );\n    link.setAttribute(\"href\", el.getAttribute( gistUrlAttr ) );\n    link.textContent = \"Comments (\" + comments.length + \")\";\n    heading.appendChild( link );\n    el.appendChild( heading );\n\n    comments.forEach(function( comment ) {\n      el.appendChild( renderComment( el, comment ) );\n    });\n  }\n\n  function renderComment ( container, comment ) {\n    var el = document.createElement(\"div\" );\n    el.setAttribute(\"class\", cssClass.container );\n    el.appendChild( renderAvatar( comment.user ) );\n\n    var content = document.createElement(\"div\" );\n    content.setAttribute(\"class\", cssClass.content );\n    content.appendChild( renderHeader( container, comment ) );\n    content.appendChild( renderCommentBody( comment ) );\n\n    el.appendChild( content );\n    return el;\n  }\n\n  function renderHeader ( container, comment ) {\n    var header = document.createElement(\"div\" );\n    header.setAttribute( \"class\", cssClass.header );\n\n    var un = document.createElement(\"a\" );\n    un.setAttribute( \"class\", cssClass.username );\n    un.setAttribute(\"href\", comment.user.html_url );\n    un.innerHTML = \"<b>\" + comment.user.login + \"</b>\";\n\n    var commentUrl = container.getAttribute( gistUrlAttr );\n    commentUrl = commentUrl + \"#comment-\" + comment.id;\n\n    var pl = document.createElement(\"a\" );\n    pl.setAttribute( \"class\", cssClass.permalink );\n    pl.setAttribute(\"href\", commentUrl );\n    pl.textContent = \"commented\";\n\n    header.appendChild( un );\n    header.appendChild( pl );\n    header.appendChild( renderTimestamp( comment.created_at ) );\n    return header;\n  }\n\n  function renderTimestamp ( timestamp ) {\n    var diff = Date.now() - new Date( timestamp ).getTime();\n    var el = document.createElement(\"time\" );\n    el.setAttribute( \"class\", cssClass.timestamp );\n    el.setAttribute( \"datetime\", timestamp );\n    el.setAttribute(\"title\", timestamp );\n\n    diff = Math.round( diff / 1000 );\n    var str;\n\n    if ( diff < 3600 ) {\n      str = Math.round( diff / 60 ) + \" minutes ago\";\n    } else if ( diff < 86400 ) {\n      var hours = Math.round( diff / 3600 );\n      str = hours === 1 ? \"an hour ago\" : hours + \" hours ago\";\n    } else {\n      var days = Math.round( diff / 86400 );\n      str = days === 1 ? \"yesterday\" : days + \" days ago\";\n    }\n\n    el.textContent = str;\n\n    return el;\n  }\n\n  function renderCommentBody ( comment ) {\n    var body = document.createElement(\"div\" );\n    body.setAttribute(\"class\", cssClass.commentBody );\n    body.innerHTML = comment.html_body;\n    return body;\n  }\n\n  function ajax ( options, success, error ) {\n    var req = new XMLHttpRequest();\n    options.type = options.type || \"GET\";\n    req.addEventListener( \"readystatechange\", function( res ) {\n      if ( req.readyState === 4 && req.status === 200 ) {\n        var data;\n        if ( options.dataType === \"json\" ) {\n          data = JSON.parse( res.target.responseText );\n        } else {\n          data = res.target.responseText;\n        }\n        success( data, res );\n      } else if ( req.readyState === 4 ) {\n        if ( error ) {\n          error( res );\n        }\n      }\n    });\n    req.open( options.type, options.url, true );\n    if ( options.reqDataType === \"json\" ) {\n      req.setRequestHeader(\"Content-type\", \"application/json\" );\n      req.send( JSON.stringify( options.data ) );\n    } else {\n      req.send( options.data );\n    }\n  }\n\n  function renderAvatar ( user ) {\n    var a = document.createElement( \"a\" );\n    a.setAttribute( \"href\", user.html_url );\n    a.setAttribute(\"class\", cssClass.avatarLink );\n    var img = document.createElement( \"img\" );\n    img.setAttribute(\"class\", cssClass.avatar );\n    img.setAttribute( \"src\", user.avatar_url );\n    img.setAttribute( \"width\", 48 );\n    img.setAttribute( \"height\", 48 );\n    a.appendChild( img );\n    return a;\n  }\n\n  hubbub.appendWidget = function( el, gistUrl ) {\n    var div = document.createElement(\"div\" );\n    div.setAttribute(\"class\", containerClass );\n    div.setAttribute( gistUrlAttr, gistUrl );\n    el.appendChild( div );\n    getComments( div, renderComments );\n  };\n\n  hubbub.css = cssClass;\n\n  return hubbub;\n})();\n"]}